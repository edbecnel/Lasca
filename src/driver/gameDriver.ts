import type { GameState } from "../core/index.ts";
import type { Move } from "../core/index.ts";

export type DriverMode = "local" | "online";

export interface HistorySnapshots {
  states: GameState[];
  notation: string[];
  currentIndex: number;
}

export interface GameDriver {
  readonly mode: DriverMode;

  getState(): GameState;
  setState(state: GameState): void;

  submitMove(move: Move): Promise<GameState & { didPromote?: boolean }>;

  finalizeCaptureChain(args:
    | { rulesetId: "dama"; state: GameState; landing: string; jumpedSquares: Set<string> }
    | { rulesetId: "damasca" | "damasca_classic"; state: GameState; landing: string }
  ): GameState & { didPromote?: boolean };

  canUndo(): boolean;
  canRedo(): boolean;
  undo(): GameState | null;
  redo(): GameState | null;
  jumpToHistory(index: number): GameState | null;

  clearHistory(): void;
  pushHistory(state: GameState, notation?: string): void;
  replaceHistory(snap: HistorySnapshots): void;
  exportHistorySnapshots(): HistorySnapshots;
  getHistory(): Array<{ index: number; toMove: "B" | "W"; isCurrent: boolean; notation: string }>;
  getHistoryCurrent(): GameState | null;
}

/**
 * Runtime-online driver surface area used by the UI/controller.
 *
 * IMPORTANT: UI code should prefer `driver.mode === "online"` over `instanceof`
 * checks, because bundlers/dev-servers can duplicate module instances and break
 * `instanceof` across package boundaries.
 */
export interface OnlineGameDriver extends GameDriver {
  readonly mode: "online";

  getServerUrl(): string | null;
  getRoomId(): string | null;
  getPlayerId(): string | null;
  getPlayerColor(): "W" | "B" | null;

  /** Latest server-reported presence info (if available). */
  getPresence(): import("../shared/onlineProtocol.ts").PresenceByPlayerId | null;

  /** Immutable per room; set by the creator at /api/create. */
  getRoomRules(): import("../shared/onlineProtocol.ts").RoomRules | null;

  /**
   * Starts realtime server push (WebSockets preferred, SSE fallback).
   * Returns true if realtime was started, else false.
   */
  startRealtime(onUpdated: () => void): boolean;

  /** Subscribe to realtime events (WS/SSE unified). */
  onSseEvent(eventName: string, cb: (payload: any) => void): () => void;

  /** Polling fallback: fetch the latest snapshot and apply it. */
  fetchLatest(): Promise<boolean>;

  /**
   * Online-only: finalize a capture chain on the server.
   * (Used by Dama/Damasca when finalization happens at end-of-sequence.)
   */
  finalizeCaptureChainRemote(
    args:
      | { rulesetId: "dama"; state: GameState; landing: string; jumpedSquares: Set<string> }
      | { rulesetId: "damasca" | "damasca_classic"; state: GameState; landing: string }
  ): Promise<GameState & { didPromote?: boolean }>;

  /** Online-only: end the current turn on the server (optionally with notation). */
  endTurnRemote(notation?: string): Promise<GameState>;

  /** Online-only: resign the game on the server. */
  resignRemote(): Promise<GameState>;

  /** Online-only: fetch replay/event log for the current room. */
  fetchReplayEvents(args?: { limit?: number }): Promise<import("../shared/onlineProtocol.ts").ReplayEvent[]>;
}
